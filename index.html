<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Stock Portfolio Management System</title>
    <!-- Load React -->
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <!--Babel for JSX -->
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <!-- Roboto from Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
    <div id="container"></div>

    <script type="text/babel">

    class Stock extends React.Component{
      constructor(props) {
        super(props);
        this.state = {count: 0, value: 0, total: 0, checked: false};

        this.remove = this.remove.bind(this);
        this.increase = this.increase.bind(this);
        this.decrease = this.decrease.bind(this);
        this.fetchData = this.fetchData.bind(this);

        this.updateTotal = this.updateTotal.bind(this);
        this.sendTotal = this.sendTotal.bind(this);

        this.handleChecked = this.handleChecked.bind(this);

        //this.testBacon = this.testBacon.bind(this);
      }

      handleChecked() {
        this.setState({checked: !this.state.checked})
        console.log('Changing checked state');
      }

      fetchData() {
        var symbol = this.props.children;
        var val;
        var client = new XMLHttpRequest();
        client.open("GET", "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=" + symbol + "&apikey=AAPWQOKX0SQKBWAM", true);
        client.onreadystatechange = function() {
        	if(client.readyState == 4) {
        		//alert(client.responseText);
            var obj = JSON.parse(client.responseText);
            //alert(obj["Meta Data"]["1. Information"]);
            //alert(obj["Time Series (Daily)"]["2018-12-18"]["4. close"]);

            var firstKey = Object.keys(obj["Time Series (Daily)"])[0];
            val = obj["Time Series (Daily)"][firstKey]["4. close"];
            this.setState({value: val});

            //for (var key in obj["Time Series (Daily)"]) {
              //alert(key);
            //}
            //alert(Object.keys(obj["Time Series (Daily)"])[0]);
          };
        }.bind(this);

        client.send();
      }

      /*
      updateTotalold() {
        //this.setState({
          //total: this.state.count * this.state.value
          //});
          this.setState((state) => {
            return {total: this.state.count * this.state.value}
            });
      }
      */

      updateTotal() {
        var calculatedTotal = this.state.count * this.state.value;
        //this.setState((state) => {
        //return {total: calculatedTotal}
        //});
        this.setState({
          total: calculatedTotal
          });
        this.sendTotal();
      }

      sendTotal() {
        this.props.updatePortfolioTotal(this.state.total, this.props.index)
      }

      remove() {
        this.props.deleteFromPortfolio(this.props.index)
      }

      increase() {
        //this.state.total = this.state.count * this.state.value
        //this.setState({
    			//count: this.state.count + 1
    			//});
        this.state.count++;
        var calculatedTotal = this.state.count * this.state.value;
        this.props.updatePortfolioTotal(calculatedTotal, this.props.index)
        this.setState((state) => {
          return {total: this.state.count * this.state.value}
          });
      }

      decrease() {
        //this.setState({
          //count: this.state.count - 1
          //});
      this.state.count--;
      var calculatedTotal = this.state.count * this.state.value;
      this.props.updatePortfolioTotal(calculatedTotal, this.props.index)
      this.setState((state) => {
        return {total: calculatedTotal}
        });
      }

      render() {
        return(
          <tr>
            <td>
              {this.props.children}
              <button onClick={this.sendTotal} className="button-danger">S</button>
            </td>
            <td>
              {this.state.value} $
              <button onClick={this.fetchData} className="button-danger">R</button>
            </td>
            <td>
              {this.state.count}
              <button onClick={this.increase} className="button-danger">+</button>
              <button onClick={this.decrease} className="button-danger">-</button>
            </td>
            <td>
              {this.state.total} $
            </td>
            <td>
            <input type="checkbox" onChange={this.handleChecked} defaultChecked={this.state.checked} />
            <button onClick={this.remove} className="button-danger">X</button>
            </td>
          </tr>
        );
      }
    };



    class Portfolio extends React.Component{
      constructor(props) {
        super(props);
        this.state = {stocks: [], amounts: [], totals: [], editing: false, adding: false};

        this.edit = this.edit.bind(this);
        this.remove = this.remove.bind(this);
        this.save = this.save.bind(this);
        this.cancel = this.cancel.bind(this);

        this.addNewStock = this.addNewStock.bind(this);
        this.cancelNewStock = this.cancelNewStock.bind(this);
        this.updateStock = this.updateStock.bind(this);
        this.removeStock = this.removeStock.bind(this);
        this.eachStock = this.eachStock.bind(this);
        this.addStock = this.addStock.bind(this);

        this.portfolioTotal = this.portfolioTotal.bind(this);

        this.test3 = 0;
      }

      addNewStock() {
        this.setState({adding: true})
      }

      cancelNewStock() {
        this.setState({adding: false})
      }

      edit() {
        this.setState({editing: true})
      }

      remove() {
        this.props.deleteFromBoard(this.props.index)
      }

      save() {
        this.props.updatePortfolioName(this.refs.newName.value, this.props.index)
        this.setState({editing: false})
      }

      cancel() {
        this.setState({editing: false})
      }

      addStock() {
        name = this.refs.addStockName.value;
        var arr = this.state.stocks;
        if (arr.length < 50){
          arr.push(name);
          this.setState({stocks: arr})
          console.log('Adding stock: ' + name);
        } else {
          console.log('Maximum number of different stocks');
          alert("You already have the maximum amount of different stocks");
        }
        this.setState({adding: false})
      }

      removeStock(i) {
        console.log('Removing stock: ' + i);
        var arr = this.state.stocks;
        arr.splice(i, 1);
        this.setState({stocks: arr})
      }

      updateStock(newAmount, i) {
        console.log('Updating stock: ' + i);
        var arr = this.state.amounts;
        arr[i] = newAmount;
        this.setState({stocks: arr})
      }

      portfolioTotal(val, i) {
        //console.log('Updating total ' + i + 'with ' + val);
        var arr = this.state.totals;
        arr[i] = val;
        this.test3 = 0;

        var j;
          for (j = 0; j < arr.length; j++) {
            this.test3 += arr[j];
          }
        //this.test3 += val;
        this.setState({totals: arr})
      }

      eachStock(name, i) {
        return (
                  <Stock key={i} index={i} updateStockAmount={this.updateStock} deleteFromPortfolio={this.removeStock} updatePortfolioTotal={this.portfolioTotal}>
                  {name}
                  </Stock>
                );
      }

      render() {
        return(
          <div className="portfolioContainer">
            <button onClick={this.remove} className="button-danger">X</button>
            <div className="portfolioName">{this.props.children}</div>

            <div id="table-wrapper">
              <div id="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th><span className="text">Name</span></th>
                            <th><span className="text">Unit value</span></th>
                            <th><span className="text">Quantity</span></th>
                            <th><span className="text">Total value</span></th>
                            <th><span className="text">Select</span></th>
                        </tr>
                    </thead>
                    <tbody>
                      {this.state.stocks.map(this.eachStock)}
                    </tbody>
                </table>
              </div>
            </div>
            <p>Total value of portfolio: {this.test3}</p>
            <p>Enter stock symbol:</p>
            <textarea ref="addStockName" defaultValue="Default Stock"></textarea>
            <button onClick={this.addStock} className="button-default">Add stock</button>
          </div>
        );
      }
    };



    class Board extends React.Component{
      constructor(props) {
        super(props);
        this.state = {portfolios: [], creating: false};

        this.add = this.add.bind(this);
        this.cancel = this.cancel.bind(this);
        this.updatePortfolio = this.updatePortfolio.bind(this);
        this.removePortfolio = this.removePortfolio.bind(this);
        this.eachPortfolio = this.eachPortfolio.bind(this);
        this.addPortfolio = this.addPortfolio.bind(this);
      }

      add() {
        this.setState({creating: true})
      }

      cancel() {
        this.setState({creating: false})
      }

      addPortfolio() {
        name = this.refs.addName.value;
        var arr = this.state.portfolios;
        if (arr.length < 10){
          arr.push(name);
          this.setState({portfolios: arr})
          console.log('Adding portfolio: ' + name);
          //this.setState({creating: false})
        } else {
          console.log('Maximum number of portfolios');
          alert("You already have the maximum amount of allowed portfolios");
        }
      }

      removePortfolio(i) {
        console.log('Removing portfolio: ' + i);
        var arr = this.state.portfolios;
        arr.splice(i, 1);
        this.setState({portfolios: arr})
      }

      updatePortfolio(newName, i) {
        console.log('Updating portfolio: ' + i);
        var arr = this.state.portfolios;
        arr[i] = newName;
        this.setState({portfolios: arr})
      }

      eachPortfolio(name, i) {
        return (
                  <Portfolio key={i} index={i} updatePortfolioName={this.updatePortfolio} deleteFromBoard={this.removePortfolio}>
                  {name}
                  </Portfolio>
                );
      }

      renderNormal() {
        return(
          <div>
            <button onClick={this.add} className="button-info">Create new portfolio</button>
            <div className="board">
              {this.state.portfolios.map(this.eachPortfolio)}
            </div>
          </div>
        );
      }

      renderForm() {
        return(
          <div>
            <button onClick={this.cancel} className="button-disabled">Create new portfolio</button>
            <p>Enter portfolio name:</p>
            <textarea ref="addName" defaultValue="Default Portfolio"></textarea>
            <button onClick={this.addPortfolio} className="button-confirm">Add</button>
            <div className="board">
              {this.state.portfolios.map(this.eachPortfolio)}
            </div>
          </div>
        );
      }

      render() {
        return(
          <div>
            <p>Enter portfolio name:</p>
            <textarea ref="addName" defaultValue="Default Portfolio"></textarea>
            <button onClick={this.addPortfolio} className="button-info">Add New Portfolio</button>
            <div className="board">
              {this.state.portfolios.map(this.eachPortfolio)}
            </div>
          </div>
        );
      }

      /*
      render() {
        return(
          <div>
            <textarea ref="test" defaultValue="Testing"></textarea>
            <button onClick={this.addPortfolio} className="button-info">Add portfolio</button>
            <div className="board">
              {this.state.portfolios.map(this.eachPortfolio)}
            </div>
          </div>
        );
      }
      */
    };

    ReactDOM.render(<Board />, document.getElementById('container'));

    </script>
  </body>
</html>
